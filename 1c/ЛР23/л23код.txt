ФОРМА РЫНОК

&НаСервереБезКонтекста
Функция ПолучитьБалансНаСервере()
	Возврат РегистрыНакопления.Счёт.Остатки().Итог("Сумма");
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьВалютуНаСервере(КодВалюты)
	Валюта = Справочники.Валюты.НайтиПоКоду(КодВалюты);
	ОстатокВалюты = 0;
	//{{КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	// Данный фрагмент построен конструктором.
	// При повторном использовании конструктора, внесенные вручную изменения будут утеряны!!!
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	СчётОстатки.КоличествоОстаток КАК КоличествоОстаток
		|ИЗ
		|	РегистрНакопления.Счёт.Остатки КАК СчётОстатки
		|ГДЕ
		|	СчётОстатки.Валюта = &Валюта";
	
	Запрос.УстановитьПараметр("Валюта", Валюта);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();
	
	Пока ВыборкаДетальныеЗаписи.Следующий() Цикл
		 ОстатокВалюты = ОстатокВалюты +  ВыборкаДетальныеЗаписи.КоличествоОстаток;
	КонецЦикла;
	
	//}}КОНСТРУКТОР_ЗАПРОСА_С_ОБРАБОТКОЙ_РЕЗУЛЬТАТА
	
	Возврат -ОстатокВалюты;
КонецФункции    

&НаСервереБезКонтекста
Функция ПолучитьСсылкуВалюта(Код)
	Возврат Справочники.Валюты.НайтиПоКоду(Код).Ссылка;
КонецФункции

&НаКлиенте
Процедура ОбновитьБаланс()
	ЕвроКурс = ПолучитьКурсВалютыНаСервере(ПолучитьСсылкуВалюта("EUR"));
	ДолларКурс = ПолучитьКурсВалютыНаСервере(ПолучитьСсылкуВалюта("USD"));
	ФунтКурс = ПолучитьКурсВалютыНаСервере(ПолучитьСсылкуВалюта("GBP"));
	
	ЕвроКурсВчера = ПолучитьКурсВалютыВчераНаСервере(ПолучитьСсылкуВалюта("EUR"));
	ДолларКурсВчера = ПолучитьКурсВалютыВчераНаСервере(ПолучитьСсылкуВалюта("USD"));
	ФунтКурсВчера = ПолучитьКурсВалютыВчераНаСервере(ПолучитьСсылкуВалюта("GBP"));

	ЕвроКолво = ПолучитьВалютуНаСервере("EUR");
	ДолларКолво = ПолучитьВалютуНаСервере("USD");
	ФунтКолво = ПолучитьВалютуНаСервере("GBP");
	Баланс = "" + ПолучитьБалансНаСервере() + " RUB";
	Евро ="" + ЕвроКолво + " EUR";
	Доллары = "" + ДолларКолво + " USD";
	Фунты = "" + ФунтКолво + " GBP";  
	ОбщаяЦенность = ЕвроКолво * ЕвроКурс + ДолларКолво * ДолларКурс + ФунтКолво * ФунтКурс;
	ОбщаяЦенностьВчера = ЕвроКолво * ЕвроКурсВчера + ДолларКолво * ДолларКурсВчера + ФунтКолво * ФунтКурсВчера;
	//ПроцентЧ = Окр((ОбщаяЦенность - ОбщаяЦенностьВчера)/ ОбщаяЦенностьВчера, 2);
	ПроцентЧ = -0.01;
	Если (ПроцентЧ > 0) Тогда
		Стрелка = "⬆";
	ИначеЕсли (ПроцентЧ < 0) Тогда 
		Стрелка = "⬇";
	Иначе
		Стрелка = "";
	КонецЕсли;
	Процент = "" + ПроцентЧ + "%";
КонецПроцедуры  

&НаСервереБезКонтекста
Функция ПолучитьКурсВалютыНаСервере(Валюта)                                          
 Отбор = Новый Структура();
 Отбор.Вставить("Валюта", Справочники.Валюты.НайтиПоНаименованию(Валюта.Наименование));
 Курс = РегистрыСведений.КурсыВалют.ПолучитьПоследнее(ТекущаяДата(),Отбор);
 Возврат Курс.Курс;
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьКурсВалютыВчераНаСервере(Валюта)                                          
 Отбор = Новый Структура();
 Отбор.Вставить("Валюта", Справочники.Валюты.НайтиПоНаименованию(Валюта.Наименование));
 Курс = РегистрыСведений.КурсыВалют.ПолучитьПоследнее(ТекущаяДата()-60*60*24,Отбор);
 Возврат Курс.Курс;
КонецФункции

&НаКлиенте
Процедура ВалютаПриИзменении(Элемент)
	Курс = ПолучитьКурсВалютыНаСервере(Валюта);
	КоличествоПриИзменении(Элемент);
КонецПроцедуры

&НаСервереБезКонтекста
Процедура КупитьВалютуНаСервере(Валюта, Количество)
	НовыйДокумент = Документы.Покупки.СоздатьДокумент();
	НовыйДокумент.Валюта = Валюта;
	НовыйДокумент.Курс = ПолучитьКурсВалютыНаСервере(Валюта);  
	НовыйДокумент.Дата = ТекущаяДата();
	НовыйДокумент.Количество = Количество;
	НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
КонецПроцедуры

&НаКлиенте
Процедура КупитьВалюту(Команда)
	КупитьВалютуНаСервере(Валюта, ДолларКолво);
	ОбновитьБаланс();
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПродатьВалютуНаСервере(Валюта, Количество)
	НовыйДокумент = Документы.Продажи.СоздатьДокумент();
	НовыйДокумент.Валюта = Валюта;
	НовыйДокумент.Курс = ПолучитьКурсВалютыНаСервере(Валюта);  
	НовыйДокумент.Дата = ТекущаяДата();
	НовыйДокумент.Количество = Количество;
	НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
КонецПроцедуры

&НаКлиенте
Процедура ПродатьВалюту(Команда)
	ПродатьВалютуНаСервере(Валюта, ДолларКолво);
	ОбновитьБаланс();
КонецПроцедуры

&НаКлиенте
Процедура КоличествоПриИзменении(Элемент)
	КОплате = Курс * Количество;
КонецПроцедуры

ФОРМА КОШЕЛЁК

&НаСервереБезКонтекста
Функция ПолучитьБалансНаСервере()
	Возврат РегистрыНакопления.Счёт.Остатки().Итог("Сумма");	
КонецФункции

&НаКлиенте
Процедура ОбновитьБаланс() 
	КодРубля = "RUB";
	Баланс = ""+ ПолучитьБалансНаСервере()+ " " + КодРубля; 
КонецПроцедуры

&НаСервереБезКонтекста
Процедура ПополнитьНаСервере(Количество)
	НовыйДокумент = Документы.Продажи.СоздатьДокумент();
	НовыйДокумент.Валюта = Справочники.Валюты.НайтиПоКоду("RUB");
	НовыйДокумент.Курс = 1;  
	НовыйДокумент.Дата = ТекущаяДата();
	НовыйДокумент.Количество = Количество;
	НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
КонецПроцедуры

&НаКлиенте
Процедура Пополнить(Команда)
	ПополнитьНаСервере(Количество); 
	ОбновитьБаланс();
КонецПроцедуры

&НаСервереБезКонтекста
Процедура СнятьНаСервере(Количество)
	НовыйДокумент = Документы.Покупки.СоздатьДокумент();
	НовыйДокумент.Валюта = Справочники.Валюты.НайтиПоКоду("RUB");
	НовыйДокумент.Курс = 1;  
	НовыйДокумент.Дата = ТекущаяДата();
	НовыйДокумент.Количество = Количество;
	НовыйДокумент.Записать(РежимЗаписиДокумента.Проведение);
КонецПроцедуры

&НаКлиенте
Процедура Снять(Команда)
	СнятьНаСервере(Количество);
	ОбновитьБаланс();
КонецПроцедуры


ФОРМА СПРАВКА

&НаСервереБезКонтекста
Функция ФигураПриИзмененииНаСервере(Фигура) 
	Код = Справочники.Фигуры.НайтиПоНаименованию(Фигура).Код;
	Структ = Новый Структура;
	Структ.Вставить("Описание", Справочники.Фигуры.НайтиПоКоду(Код).Описание);
	Структ.Вставить("Картинка", БиблиотекаКартинок["Картинка" +Код]);
	Возврат Структ;
КонецФункции

&НаКлиенте
Процедура ФигураПриИзменении(Элемент)
	Структ = ФигураПриИзмененииНаСервере(Фигура);
	Описание = Структ.Описание;
	Картинка = Структ.Картинка;
КонецПроцедуры
